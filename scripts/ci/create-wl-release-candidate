#!/bin/bash

set -eux

ROOT="$PWD"
VERSION="$(cat version/number)"
GOOS=${GOOS:?}
GOARCH=${GOARCH:?}

MY_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# This script expects that it lives two directories below the base directory.
BASE_DIR="$( cd ${MY_DIR}/../.. && pwd )"

pushd ${BASE_DIR}
  mkdir -p $GOPATH/src/github.com/robdimsdale
  ln -s $PWD $GOPATH/src/github.com/robdimsdale/wundergo

  go get gopkg.in/yaml.v2

  IFS='-' read -ra arrVERSION <<< "${VERSION}"
  stripped_version="${arrVERSION[0]}"

  GOOS="${GOOS}" \
  GOARCH="${GOARCH}" \
  go build \
    -o "${ROOT}"/wl-"${GOOS}-${GOARCH}-${VERSION}" \
    -ldflags "-X main.version=${stripped_version}" \
    ./cmd/wl/main.go
popd
